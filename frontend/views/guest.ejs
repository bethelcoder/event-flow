<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/guest.css">

    <link rel="stylesheet" href="../styles/map.css">
    <link rel="stylesheet" href="../styles/popup_announcement.css">
    <link rel="stylesheet" href="../styles/notificationcount.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <title>Document</title>
</head>
<body>
         <script>
        const user = {
            role: "<%= user.role %>",
            Username: "<%= user.displayName %>",
            _id: "<%= user._id %>",
        };
        const event = {
            _id: "<%= event._id %>",
        };
    </script>
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  <script src="../scripts/socket.js"></script>
    <section class="guest_heading">
        <section class="heading">
            <h2>Welcome, <%= guestName %></h2>
            <p><%= eventName%></p>
            <section id="announcement-popup" class="announcement-container"></section>
        </section>
    </section>
    <section class="pages">
        <button class="btn_tablink" onclick="openPage('qr',this)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
            </svg>
            My Pass
        </button>
        <button class="btn_tablink" onclick="openPage('program',this)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
            </svg>
            program
        </button>
        <button class="btn_tablink" onclick="openPage('announce',this)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46" />
            </svg>

            Announcements <span class="notif-count"><%= notifcount %></span>
        </button>
        <button class="btn_tablink" onclick="openPage('venue',this)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z" />
            </svg>
            Venue Map
        </button>
        <button class="btn_tablink" onclick="openPage('report',this)">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />
            </svg>
            Report issue
        </button>
    </section>


    <section class="QR" id="qr">
        <section class="fields">
            <section class="qr_field">
                <span class="Headings">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 3.75 9.375v-4.5ZM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 0 1-1.125-1.125v-4.5ZM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0 1 13.5 9.375v-4.5Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 6.75h.75v.75h-.75v-.75ZM6.75 16.5h.75v.75h-.75v-.75ZM16.5 6.75h.75v.75h-.75v-.75ZM13.5 13.5h.75v.75h-.75v-.75ZM13.5 19.5h.75v.75h-.75v-.75ZM19.5 13.5h.75v.75h-.75v-.75ZM19.5 19.5h.75v.75h-.75v-.75ZM16.5 16.5h.75v.75h-.75v-.75Z" />
                    </svg>
                    <h4>Your Event pass</h4>
                </span>
                <section class="code">
                    <img src="<%= venueImage %>" alt="Venue Image" class="guest-event">
                    <strong>Venue </strong>
                    <p>One of our prestigious venues at your service</p>
                </section>
            </section>

            <section class="event_details">
                <span class="Headings"> <h4>Event Details</h4></span>
                <section class="row">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                    </svg>
                    <section class="detail">
                        <strong>Event Date</strong>
                        <p><%= new Date(eventDate).toLocaleString('en-GB', { 
                               day: '2-digit', month: 'short', year: 'numeric', 
                               hour: '2-digit', minute: '2-digit' 
                           }) %></p>
                    </section>
                </section>
                <section class="row">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    <section class="detail"> 
                        <strong>Address</strong>
                        <p><%= eventVenue %></p>
                    </section>
                </section>
                <section class="row">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
                    </svg>
                    <section class="detail"> 
                        <strong>Venue</strong>
                        <p><%= eventPlaceName %></p>
                    </section>
                </section>
                <section class="row">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                    </svg>
                    <section class="detail"> 
                        <strong>Description</strong>
                        <p><%= eventDescription %></p>
                    </section>
                </section>
                <section class="row">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                    </svg>
                    <section class="detail">
                        <strong>Registerd Email</strong>
                        <p><%= guestEmail %></p>
                    </section>
                </section>
                <section class="Emergency">
                    <p><strong>Important: </strong> Keep this QR code accessible on your phone. You'll need it for entry and any on-site services.</p>
                </section>
            </section>
        </section>
        
    </section>


<section class="Program" id="program">
    <span class="Headings">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
        </svg>
        <h4>Event Program</h4>
    </span>

    <% sessions.forEach(session => { %>
        <section class="event_program">
            <section class="time">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                <%= new Date(session.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
            </section>
            <section class="program_details">
                <section>
                    <h4><%= session.title %></h4>
                    <p><%= session.description %></p>
                    <small>Speaker: <%= session.speaker %></small>
                </section>
                <span><%= session.location %></span>
            </section>
        </section>
    <% }) %>
</section>

<!-- anouncement -->
<section class="announcement-section" id="announce">
    <span class="Headings">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 0 0 1.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 0 1 0 3.46" />
        </svg>
        <h4>Event Announcements</h4>
    </span>
  <% if(announcements.length === 0) { %>
    <section class="no-announcements">No announcements yet</section>
  <% } else { %>
    <% announcements.forEach(announcement => { %>
      <section class="announcement-card">
        <section class="announcement-header">
          <section class="announcement-title"><%= announcement.title %></section>
          <section class="announcement-meta">
            <%= new Date(announcement.createdAt).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) %> 
            — Event Manager
          </section>
        </section>
        <section class="announcement-body"><%= announcement.message %></section>
      </section>
    <% }) %>
  <% } %>
</section>


    <section class="Venue" id="venue">
        <span class="Headings">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z" />
            </svg>
            <h4>Venue Map & Direction</h4>
        </span>
        <section class="map">
            <section id="map" style="height:800px;"> </section>
            <h2>Map Descriptions</h2>
            <section id="savedNotes" style="padding:10px; border:1px solid #ccc; border-radius:6px; min-height:50px;"></section>
        </section>
        
    </section>

    <section class="Report" id="report">
        <form class="issue" method="post" action="/guests/report-issue/<%=guestId %>">
            <span class="Headings">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />
                </svg>
                <h4>Report an Issue</h4>
            </span>
            <section class="Row1">
                <section class="column">
                    <h5>Issue Type</h5>
                    <input type="text" name="issue_type" placeholder="e.g, Technical problem, Safety, Concern, Lost Item">
                </section>
                <section class="column">
                    <h5>Location</h5>
                    <input type="text" name="incident_setting" placeholder="e.g, Main Auditorium, Lobby, Room A">
                </section>
            </section>
            <section class="column">
                <h5>Description</h5>
                <textarea rows="5" name="issue_description" placeholder="Please provide detailed information about the issue..."></textarea>
            </section>
            <h5>Priority Level</h5>
            <select id="priority" name="priority">
                <option value="Low">Low - General enquiry</option>
                <option value="Medium">Medium - Needs attention</option>
                <option value="High">High - Urgent issue</option>
            </select>
            <button type="submit">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3v1.5M3 21v-6m0 0 2.77-.693a9 9 0 0 1 6.208.682l.108.054a9 9 0 0 0 6.086.71l3.114-.732a48.524 48.524 0 0 1-.005-10.499l-3.11.732a9 9 0 0 1-6.085-.711l-.108-.054a9 9 0 0 0-6.208-.682L3 4.5M3 15V4.5" />
                </svg>
                Submit Report
            </button>
            <section class="Emergency">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="guest_icon">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
                </svg>
                <strong>Emergency Contact</strong>
                <p>For urgent matters, call event support: (+01) 6610 0221</p>
            </section>
        </form>
    </section>
    
    <script src="/scripts/guest.js"></script>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script> var savedAnnotations = <%- JSON.stringify(annotations) %> </script>

    <script>
    var map = L.map('map', { crs: L.CRS.Simple, minZoom: -1.4, maxZoom: 2 });
    var w = 2000, h = 1500;
    var bounds = [[0, 0], [h, w]];
    map.fitBounds(bounds);
    map.setMaxBounds(bounds);

    // Load floor plan
    <% if (map) { %>
        L.imageOverlay("<%= map.url %>", bounds).addTo(map);
    <% } %>

    var drawnItems = new L.FeatureGroup().addTo(map);

    // Add saved annotations from manager
    savedAnnotations.forEach(a => {
        if (a.type === 'marker' && a.coords) {
            const marker = L.marker([a.coords.lat, a.coords.lng]);
            drawnItems.addLayer(marker);
        } else if (a.type === 'circle' && a.center && a.radius) {
            const circle = L.circle([a.center.lat, a.center.lng], { radius: a.radius });
            drawnItems.addLayer(circle);
        }
    });
    const notesDiv = document.getElementById('savedNotes');
    const firstNoteAnnotation = savedAnnotations.find(a => a.notes && a.notes.trim() !== "");
    if (firstNoteAnnotation) {
        notesDiv.textContent = firstNoteAnnotation.notes;
    }
</script>
<script src="../scripts/guestSocket.js"></script>
<script>
  const notifEl = document.querySelector('.notif-count');
  let notifCount = Number(notifEl.textContent) || 0;

  const updateBadge = () => {
    notifEl.style.display = notifCount > 0 ? 'inline-block' : 'none';
    notifEl.textContent = notifCount;
  };

  updateBadge();

  socket.on('newAnnouncement', (a) => {
    notifCount++;
    updateBadge();

    const div = document.createElement('div');
    div.className = `announcement ${a.priority}`;
    div.innerHTML = `<strong>${a.title}</strong>: ${a.message}`;
    document.getElementById('announcement-popup').appendChild(div);

    setTimeout(() => div.remove(), 5000);
  });
</script>



    
</body>
</html>